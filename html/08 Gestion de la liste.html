<h1 id="gestion-de-la-liste-des-films">Gestion de la liste des
films</h1>
<p>Observez bien en détail le ‘data’ retourné par l’appel API. Que
voyez-vous ? Combien de films sont renvoyés ? Combien de films sont
disponibles ?</p>
<p>En réalité l’appel API ne nous renvoie qu’un nombre limité de films
(ici 20) mais il peut y en avoir beaucoup plus ! Il faut donc gérer la
pagination.</p>
<p>Regardez dans la documentation de <a
href="https://reactnative.dev/docs/flatlist#onendreached">FlatList</a></p>
<p>On trouve deux attributs : <code>onEndReached</code> et
<code>onEndReachedThreshold</code><br>
<code>onEndReachedThreshold</code> est une valeur qui indique à quel
moment <code>onEndReached</code> doit être appelé
<code>onEndReached</code> est un événement qui doit être appelé
lorsqu’on défile vers la fin de la liste Le paramètre suggéré pour
<code>onEndReachedThreshold</code> est <code>0.5</code> : lorsque la
moitié de la liste est atteinte, on va actualiser</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// http://api.themoviedb.org/3/search/movie?api_key=VOTRE_TOKEN_ICI&amp;language=fr&amp;query=Star</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">page</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">total_results</span><span class="op">:</span> <span class="dv">1981</span><span class="op">,</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">total_pages</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">results</span><span class="op">:</span> [</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>        {<span class="op">...</span>}</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>page</code> et <code>total_pages</code> vont nous permettre de
gérer la pagination</p>
<p>On va ajouter deux attributs à notre composant</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Components/Search.js</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">constructor</span>(props) {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">page</span> <span class="op">=</span> <span class="dv">0</span> <span class="co">// Compteur pour connaître la page courante</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">totalPages</span> <span class="op">=</span> <span class="dv">0</span> <span class="co">// Nombre de pages totales pour savoir si on a atteint la fin des retours de l&#39;API</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">//...</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Ajouter à notre appel API : bien noter <strong>“&amp;page=” +
page</strong> et modification de l’appel de la fonction<br> Notez bien
<strong>this.page + 1</strong> Notez bien <strong><code>maxHeight:
5000</code></strong> remarque <strong>mieux gérer cela si
possible</strong> Notez aussi la condition
<strong><code>!isLoading</code></strong></p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// API/TMDBApi.js</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> getFilmsFromApiWithSearchedText <span class="op">=</span> <span class="kw">async</span> (text<span class="op">,</span> page) <span class="kw">=&gt;</span> {</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> url <span class="op">=</span> <span class="co">/* ... */</span> <span class="op">+</span> <span class="st">&#39;&amp;language=fr&amp;query=&#39;</span> <span class="op">+</span> text <span class="op">+</span> <span class="st">&quot;&amp;page=&quot;</span> <span class="op">+</span> page</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Components/Search.js</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">_loadFilms</span>() {</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">searchedText</span><span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="kw">this</span><span class="op">.</span><span class="at">isLoading</span>) {</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="fu">getFilmsFromApiWithSearchedText</span>(<span class="kw">this</span><span class="op">.</span><span class="at">searchedText</span><span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">page</span> <span class="op">+</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">then</span>((data) <span class="kw">=&gt;</span> {</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">page</span> <span class="op">=</span> data<span class="op">.</span><span class="at">page</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="at">totalPages</span> <span class="op">=</span> data<span class="op">.</span><span class="at">total_pages</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">setState</span>({</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>          <span class="co">// ... syntaxe Javascript ES6 qui permet de recopier</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>          <span class="co">// et de fusionner les deux tableaux</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>          <span class="co">// ⟺ films: this.state.films.concat(data.results)</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>          <span class="dt">films</span><span class="op">:</span> [<span class="op">...</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">films</span><span class="op">,</span> <span class="op">...</span>data<span class="op">.</span><span class="at">results</span>]<span class="op">,</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>          <span class="dt">isLoading</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>View style<span class="op">=</span>{ { <span class="dt">marginTop</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span> <span class="dt">maxHeight</span><span class="op">:</span> <span class="dv">5000</span> } }<span class="op">&gt;</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>FlatList</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    onEndReachedThreshold<span class="op">=</span>{<span class="fl">0.5</span>}</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    onEndReached<span class="op">=</span>{() <span class="kw">=&gt;</span> {</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="kw">this</span><span class="op">.</span><span class="at">page</span> <span class="op">&lt;</span> <span class="kw">this</span><span class="op">.</span><span class="at">totalPages</span>) { <span class="co">// On vérifie qu&#39;on n&#39;a pas atteint la fin de la pagination (totalPages) avant de charger plus d&#39;éléments</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>          <span class="kw">this</span><span class="op">.</span><span class="fu">_loadFilms</span>()</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>        } } }</span></code></pre></div>
<p>Tester. Constater que les pages défilent correctement.</p>
<p>Maintenant il faut faire la différence entre le fait d’effectuer une
nouvelle rechercher et le fait d’aller à la page suivante.<br> Ajout et
appel de la fonction _searchFilms pour les recherches</p>
<p>Voir la documentation de <a
href="https://fr.reactjs.org/docs/react-component.html#setstate">setState</a></p>
<p>Sans le <strong><code>maxHeight: 5000</code></strong> les listItem
remplissent tout</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">_searchFilms</span>() {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">page</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">totalPages</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// setState est une fonction asychrone</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Pour améliorer les performances React peut en différer les traitements</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Elle prend un deuxième paramètre</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">//      une fonction callback qui est appelée lorsque tout est prêt</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">setState</span>({</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">films</span><span class="op">:</span> []<span class="op">,</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;Page : &quot;</span> <span class="op">+</span> <span class="kw">this</span><span class="op">.</span><span class="at">page</span> <span class="op">+</span> <span class="st">&quot; / TotalPages : &quot;</span> <span class="op">+</span> <span class="kw">this</span><span class="op">.</span><span class="at">totalPages</span> <span class="op">+</span> <span class="st">&quot; / Nombre de films : &quot;</span> <span class="op">+</span> <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">films</span><span class="op">.</span><span class="at">length</span>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">_loadFilms</span>()</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>TextInput</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  style<span class="op">=</span>{styles<span class="op">.</span><span class="at">textinput</span>}</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  placeholder<span class="op">=</span><span class="st">&#39;Titre du film&#39;</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  onChangeText<span class="op">=</span>{(text) <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">_searchTextInputChanged</span>(text)}</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  onSubmitEditing<span class="op">=</span>{() <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">_searchFilms</span>()}</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="op">/&gt;</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>Button title<span class="op">=</span><span class="st">&#39;Rechercher&#39;</span> onPress<span class="op">=</span>{() <span class="kw">=&gt;</span> <span class="kw">this</span><span class="op">.</span><span class="fu">_searchFilms</span>()}<span class="op">/&gt;</span></span></code></pre></div>
<p>Après quelques tests on constate que le id renvoyé par l’API produit
parfois des doublons. Solution : ajouter un listId et l’utiliser.</p>
<ul>
<li>La fonction <code>crypto.randomUUID()</code> pour générer le
listId</li>
<li>On va installer le module uuid : <code>yarn add uuid</code></li>
<li>Dans API/TMDBApi.js ajouter une boucle pour ajouter le listId aux
résultats</li>
</ul>
<div class="sourceCode" id="cb5"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>  <span class="im">import</span> { v4 <span class="im">as</span> uuidv4 } <span class="im">from</span> <span class="st">&#39;uuid&#39;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* ... */</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  response<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">results</span><span class="op">.</span><span class="fu">forEach</span>(<span class="kw">function</span> (part<span class="op">,</span> index) {</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span>[index]<span class="op">.</span><span class="at">listId</span> <span class="op">=</span> <span class="fu">uuidv4</span>() <span class="op">+</span> page <span class="op">+</span> i<span class="op">++;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span> response<span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">results</span>)<span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> response<span class="op">.</span><span class="at">data</span><span class="op">;</span><span class="vs">`</span></span></code></pre></div>
<ul>
<li>Dans Components/Search.js, au niveau de la Flatlist, changer le
keyExtractor</li>
</ul>
<div class="sourceCode" id="cb6"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>  keyExtractor<span class="op">=</span>{ (item) <span class="kw">=&gt;</span> item<span class="op">.</span><span class="at">listId</span> }</span></code></pre></div>
<p>Tester, observer les logs</p>
